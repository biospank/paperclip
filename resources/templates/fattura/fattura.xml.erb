<?xml version="1.0" encoding="UTF-8"?>
<p:FatturaElettronica versione="FPR12" xmlns:ds="http://www.w3.org/2000/09/xmldsig#"
xmlns:p="http://ivaservizi.agenziaentrate.gov.it/docs/xsd/fatture/v1.2"
xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
xsi:schemaLocation="http://ivaservizi.agenziaentrate.gov.it/docs/xsd/fatture/v1.2 http://www.fatturapa.gov.it/export/fatturazione/sdi/fatturapa/v1.2/Schema_del_file_xml_FatturaPA_versione_1.2.xsd">
  <FatturaElettronicaHeader>
    <DatiTrasmissione>
      <IdTrasmittente>
        <IdPaese>IT</IdPaese>
        <IdCodice><%= dati_azienda.cod_fisc %></IdCodice>
      </IdTrasmittente>
      <ProgressivoInvio><%= fattura.num %></ProgressivoInvio>
      <FormatoTrasmissione>FPR12</FormatoTrasmissione>
      <CodiceDestinatario>??0000000?? 1.1.4</CodiceDestinatario>
      <PECDestinatario>?? 1.1.6</PECDestinatario>
      <ContattiTrasmittente/>
    </DatiTrasmissione>
    <CedentePrestatore>
      <DatiAnagrafici>
        <IdFiscaleIVA>
          <IdPaese>IT</IdPaese>
          <IdCodice><%= dati_azienda.p_iva %></IdCodice>
        </IdFiscaleIVA>
        <Anagrafica>
          <Denominazione><%= dati_azienda.denominazione %></Denominazione>
        </Anagrafica>
        <RegimeFiscale><%= dati_azienda.regime_fiscale %></RegimeFiscale>
      </DatiAnagrafici>
      <Sede>
        <Indirizzo><%= dati_azienda.indirizzo %></Indirizzo>
        <CAP><%= dati_azienda.cap %></CAP>
        <Comune><%= dati_azienda.comune %></Comune>
        <Provincia><%= dati_azienda.provincia %></Provincia>
        <Nazione>IT</Nazione>
      </Sede>
    </CedentePrestatore>
    <CessionarioCommittente>
      <DatiAnagrafici>
        <% if cliente.p_iva? %>
          <IdFiscaleIVA>
            <IdPaese>IT</IdPaese>
            <IdCodice><%= cliente.p_iva %></IdCodice>
          </IdFiscaleIVA>
        <% else %>
          <CodiceFiscale><%= cliente.cod_fisc %></CodiceFiscale>
        <% end %>
        <Anagrafica>
          <Denominazione><%= cliente.denominazione %></Denominazione>
        </Anagrafica>
      </DatiAnagrafici>
      <Sede>
        <Indirizzo><%= cliente.indirizzo %></Indirizzo>
        <CAP><%= cliente.cap %></CAP>
        <Comune><%= cliente.comune %></Comune>
        <Provincia><%= cliente.provincia %></Provincia>
        <Nazione>IT</Nazione>
      </Sede>
    </CessionarioCommittente>
  </FatturaElettronicaHeader>
  <FatturaElettronicaBody>
    <DatiGenerali>
      <DatiGeneraliDocumento>
        <TipoDocumento><%= fattura.nota_di_credito? ? 'Nota di credito' : 'Fattura' %></TipoDocumento>
        <Divisa>EUR</Divisa>
        <Data><%= fattura.data_emissione %></Data>
        <Numero><%= fattura.num %></Numero>
        <% if ritenuta = fattura.ritenuta %>
          <DatiRitenuta>
            <TipoRitenuta>???</TipoRitenuta>
            <ImportoRitenuta>???</ImportoRitenuta>
            <AliquotaRitenuta><%= ritenuta.percentuale %></AliquotaRitenuta>
            <CausalePagamento>???</CausalePagamento>
          </DatiRitenuta>
        <% end %>
        <ImportoTotaleDocumento><%= Helpers::ApplicationHelper.number_text(fattura.importo) %></ImportoTotaleDocumento>
        <Causale>???</Causale>
        <Causale>SEGUE DESCRIZIONE CAUSALE NEL CASO IN CUI NON SIANO STATI SUFFICIENTI 200 CARATTERI AAAAAAAAAAA BBBBBBBBBBBBBBBBB</Causale>
      </DatiGeneraliDocumento>
      <DatiOrdineAcquisto>
        <RiferimentoNumeroLinea>???</RiferimentoNumeroLinea>
        <IdDocumento>???</IdDocumento>
        <NumItem>???</NumItem>
      </DatiOrdineAcquisto>
      <DatiContratto>
  	    <RiferimentoNumeroLinea>???</RiferimentoNumeroLinea>
  	    <IdDocumento>???</IdDocumento>
  	    <Data>???</Data>
  	    <NumItem>???</NumItem>
  	    <CodiceCUP>???</CodiceCUP>
  	    <CodiceCIG>456def</CodiceCIG>
      </DatiContratto>
      <DatiTrasporto>???
  	    <DatiAnagraficiVettore>
  	      <IdFiscaleIVA>
  	        <IdPaese>IT</IdPaese>
  	        <IdCodice>24681012141</IdCodice>
  	      </IdFiscaleIVA>
      	  <Anagrafica>
  	        <Denominazione>Trasporto spa</Denominazione>
  	      </Anagrafica>
  	    </DatiAnagraficiVettore>
	    <DataOraConsegna>2012-10-22T16:46:12.000+02:00</DataOraConsegna>
      </DatiTrasporto>
    </DatiGenerali>
    <DatiBeniServizi>
      <% if configatron.attivita == Models::Azienda::ATTIVITA[:commercio] %>
        <% fattura.righe_fattura_cliente.each_with_index do |riga, idx| %>
          <DettaglioLinee>
            <NumeroLinea><%= idx + 1 %></NumeroLinea>
            <Descrizione><%= riga.descrizione %></Descrizione>
            <Quantita><%= (riga.qta.zero?) ? '' : riga.qta.to_s %></Quantita>
            <PrezzoUnitario><%= (riga.importo.zero?) ? '' : Helpers::ApplicationHelper.number_text(riga.importo) %></PrezzoUnitario>
              <%
                importo_t = nil
                if riga.qta.zero?
                  importo_t = riga.importo unless riga.importo.zero?
                else
                  importo_t = (riga.qta * riga.importo)
                end
              %>
              <PrezzoTotale><%= (importo_t.nil?) ? '' :  Helpers::ApplicationHelper.number_text(importo_t) %></PrezzoTotale>
            <AliquotaIVA><%= Helpers::ApplicationHelper.number_text(riga.aliquota.percentuale) %></AliquotaIVA>
          </DettaglioLinee>
        <% end %>
      <% else %>
        <% fattura.righe_fattura_cliente.each_with_index do |riga, idx| %>
          <DettaglioLinee>
            <NumeroLinea><%= idx + 1 %></NumeroLinea>
            <Descrizione><%= riga.descrizione %></Descrizione>
            <Quantita/>
            <PrezzoUnitario/>
            <PrezzoTotale><%= Helpers::ApplicationHelper.number_text(riga.importo) %></PrezzoTotale>
            <AliquotaIVA><%= Helpers::ApplicationHelper.number_text(riga.aliquota.percentuale) %></AliquotaIVA>
          </DettaglioLinee>
        <% end %>
      <% end %>
      <% riepilogo_imposte.each do |imposta| %>
        <DatiRiepilogo>
          <AliquotaIVA><%= Helpers::ApplicationHelper.number_text(imposta.percentuale) %></AliquotaIVA>
          <ImponibileImporto><%= imposta.imponibile %></ImponibileImporto>
          <Imposta><%= imposta.totale %></Imposta>
          <EsigibilitaIVA>???</EsigibilitaIVA>
        </DatiRiepilogo>
      <% end %>
    </DatiBeniServizi>
    <DatiPagamento>
      <CondizioniPagamento>???</CondizioniPagamento>
      <DettaglioPagamento>
        <ModalitaPagamento>???</ModalitaPagamento>
        <DataScadenzaPagamento>???</DataScadenzaPagamento>
        <ImportoPagamento>???</ImportoPagamento>
      </DettaglioPagamento>
    </DatiPagamento>
  </FatturaElettronicaBody>
</p:FatturaElettronica>
